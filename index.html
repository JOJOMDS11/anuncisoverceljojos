<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOJO AN√öNCIOS - Painel Discord</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Form */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-form h1 {
            color: #5865f2;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        /* Main Interface */
        .main-interface {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-content h1 {
            color: #5865f2;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header-content p {
            color: #666;
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stats-card {
            background: rgba(88, 101, 242, 0.1);
            border: 2px solid #5865f2;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-width: 120px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5865f2;
            display: block;
        }

        .stats-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .panel-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .panel-section:hover {
            transform: translateY(-5px);
        }

        .panel-section h2 {
            color: #5865f2;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        select, textarea, input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: #5865f2;
            box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #ff6b35;
        }

        .char-counter.danger {
            color: #dc3545;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #5865f2, #4752c4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(88, 101, 242, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Roles Selection */
        .roles-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .role-item {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-item:hover {
            border-color: #5865f2;
        }

        .role-item.selected {
            border-color: #5865f2;
            background: rgba(88, 101, 242, 0.1);
        }

        .role-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .role-name {
            font-weight: 500;
            font-size: 14px;
        }

        /* Channel Creation */
        .channel-creation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .channel-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .channel-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .channel-type-btn.active {
            border-color: #5865f2;
            background: rgba(88, 101, 242, 0.1);
            color: #5865f2;
        }

        /* Announcement Types */
        .announcement-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .announcement-type {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .announcement-type:hover {
            border-color: #5865f2;
        }

        .announcement-type.selected {
            border-color: #5865f2;
            background: rgba(88, 101, 242, 0.1);
            color: #5865f2;
        }

        .announcement-type-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .announcement-type-name {
            font-weight: 600;
            font-size: 14px;
        }

        /* Emoji Picker */
        .emoji-picker {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 120px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .emoji-btn {
            padding: 8px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .emoji-btn:hover {
            background: #e9ecef;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-actions button {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Templates Section */
        .history-section, .templates-section, .channels-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .template-item, .channel-item {
            background: #f8f9fa;
            border-left: 4px solid #5865f2;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0 15px 15px 0;
            transition: all 0.3s ease;
        }

        .template-item:hover, .channel-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .template-info {
            flex-grow: 1;
        }

        .template-name, .channel-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .template-category, .channel-type {
            font-size: 0.8rem;
            color: #5865f2;
            background: rgba(88, 101, 242, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .template-preview {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .template-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .success, .error, .info {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar input, .filter-bar select {
            width: auto;
            min-width: 200px;
        }

        /* Mentions Preview */
        .mentions-preview {
            background: rgba(88, 101, 242, 0.1);
            border: 1px solid #5865f2;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .mentions-preview.show {
            display: block;
        }

        .mention-tag {
            background: #5865f2;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
            display: inline-block;
        }

        @media (max-width: 1200px) {
            .panel-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .roles-grid {
                grid-template-columns: 1fr;
            }
            
            .announcement-type-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .channel-creation {
                grid-template-columns: 1fr;
            }
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <h1>üì¢ JOJO AN√öNCIOS</h1>
            <div id="loginMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="password">Senha de Administrador:</label>
                    <input type="password" id="password" placeholder="Digite a senha..." required>
                </div>
                <button type="submit" class="btn" id="loginBtn">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Interface Principal -->
    <div id="mainInterface" class="main-interface">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>üéØ JOJO AN√öNCIOS</h1>
                    <p>Painel completo para gerenciar Discord - An√∫ncios, Canais & Templates</p>
                </div>
                <div class="header-actions">
                    <div class="stats-card">
                        <span class="stats-number" id="statsAnnouncements">0</span>
                        <div class="stats-label">An√∫ncios</div>
                    </div>
                    <div class="stats-card">
                        <span class="stats-number" id="statsChannels">0</span>
                        <div class="stats-label">Canais</div>
                    </div>
                    <div class="stats-card">
                        <span class="stats-number" id="statsRoles">0</span>
                        <div class="stats-label">Cargos</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">üö™ Sair</button>
                </div>
            </div>

            <div class="panel-grid">
                <!-- Se√ß√£o Principal de An√∫ncios -->
                <div class="panel-section">
                    <h2>üì¢ Criar An√∫ncio</h2>
                    <div id="message"></div>
                    
                    <!-- Tipo de An√∫ncio -->
                    <div class="form-group">
                        <label>Tipo de An√∫ncio:</label>
                        <div class="announcement-type-grid">
                            <div class="announcement-type selected" data-type="anuncio">
                                <div class="announcement-type-icon">üì¢</div>
                                <div class="announcement-type-name">An√∫ncio</div>
                            </div>
                            <div class="announcement-type" data-type="novidade">
                                <div class="announcement-type-icon">‚ú®</div>
                                <div class="announcement-type-name">Novidade</div>
                            </div>
                            <div class="announcement-type" data-type="atualizacao">
                                <div class="announcement-type-icon">üîÑ</div>
                                <div class="announcement-type-name">Atualiza√ß√£o</div>
                            </div>
                            <div class="announcement-type" data-type="torneio">
                                <div class="announcement-type-icon">üèÜ</div>
                                <div class="announcement-type-name">Inscri√ß√£o de Torneio</div>
                            </div>
                            <div class="announcement-type" data-type="evento">
                                <div class="announcement-type-icon">üéâ</div>
                                <div class="announcement-type-name">Evento</div>
                            </div>
                            <div class="announcement-type" data-type="aviso">
                                <div class="announcement-type-icon">‚ö†Ô∏è</div>
                                <div class="announcement-type-name">Aviso</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button type="button" class="btn btn-secondary btn-small" onclick="refreshChannels()">
                            üîÑ Atualizar
                        </button>
                        <button type="button" class="btn btn-secondary btn-small" onclick="previewAnnouncement()">
                            üëÅÔ∏è Visualizar
                        </button>
                        <button type="button" class="btn btn-secondary btn-small" onclick="clearForm()">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                    
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="channelSelect">Canal de Destino:</label>
                            <select id="channelSelect" required>
                                <option value="">Carregando canais...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="templateSelect">Template (opcional):</label>
                            <select id="templateSelect">
                                <option value="">Selecione um template</option>
                            </select>
                        </div>

                        <!-- Sele√ß√£o de Cargos -->
                        <div class="roles-section">
                            <label>Cargos para Mencionar:</label>
                            <div class="roles-grid" id="rolesGrid">
                                <div class="role-item" data-loading="true">
                                    <div class="loading-spinner"></div>
                                    Carregando cargos...
                                </div>
                            </div>
                            <div class="mentions-preview" id="mentionsPreview">
                                <label style="margin-bottom: 5px; font-size: 12px;">Men√ß√µes que ser√£o enviadas:</label>
                                <div id="mentionTags"></div>
                            </div>
                        </div>

                        <!-- Seletor de Emojis -->
                        <div class="emoji-picker">
                            <label>Emojis R√°pidos:</label>
                            <div class="emoji-grid">
                                <button type="button" class="emoji-btn" data-emoji="üì¢">üì¢</button>
                                <button type="button" class="emoji-btn" data-emoji="üéâ">üéâ</button>
                                <button type="button" class="emoji-btn" data-emoji="‚ö†Ô∏è">‚ö†Ô∏è</button>
                                <button type="button" class="emoji-btn" data-emoji="üî•">üî•</button>
                                <button type="button" class="emoji-btn" data-emoji="üíé">üíé</button>
                                <button type="button" class="emoji-btn" data-emoji="üéØ">üéØ</button>
                                <button type="button" class="emoji-btn" data-emoji="üöÄ">üöÄ</button>
                                <button type="button" class="emoji-btn" data-emoji="‚≠ê">‚≠ê</button>
                                <button type="button" class="emoji-btn" data-emoji="üèÜ">üèÜ</button>
                                <button type="button" class="emoji-btn" data-emoji="üí™">üí™</button>
                                <button type="button" class="emoji-btn" data-emoji="üëë">üëë</button>
                                <button type="button" class="emoji-btn" data-emoji="‚ú®">‚ú®</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementText">Mensagem do An√∫ncio:</label>
                            <textarea id="announcementText" placeholder="Digite sua mensagem aqui... Use emojis para deixar mais atrativo! üòä" required maxlength="2000"></textarea>
                            <div class="char-counter" id="charCounter">0/2000 caracteres</div>
                        </div>
                        
                        <button type="submit" class="btn" id="sendBtn">
                            üì§ Enviar An√∫ncio
                        </button>
                    </form>
                </div>

                <!-- Se√ß√£o de Gerenciamento -->
                <div>
                    <!-- Templates -->
                    <div class="panel-section" style="margin-bottom: 20px;">
                        <h2>üìù Template R√°pido</h2>
                        <form id="templateForm">
                            <div class="form-group">
                                <label for="templateName">Nome:</label>
                                <input type="text" id="templateName" placeholder="Ex: Evento Semanal" required maxlength="100">
                            </div>
                            
                            <div class="form-group">
                                <label for="templateCategory">Categoria:</label>
                                <select id="templateCategory">
                                    <option value="Geral">Geral</option>
                                    <option value="Eventos">Eventos</option>
                                    <option value="Avisos">Avisos</option>
                                    <option value="Torneios">Torneios</option>
                                    <option value="Atualiza√ß√µes">Atualiza√ß√µes</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="templateContent">Conte√∫do:</label>
                                <textarea id="templateContent" placeholder="Conte√∫do do template..." required maxlength="2000"></textarea>
                                <div class="char-counter" id="templateCharCounter">0/2000 caracteres</div>
                            </div>
                            
                            <button type="submit" class="btn btn-secondary" id="saveTemplateBtn">
                                üíæ Salvar
                            </button>
                        </form>
                    </div>

                    <!-- Cria√ß√£o de Canais -->
                    <div class="panel-section">
                        <h2>üì∫ Criar Canal</h2>
                        <form id="channelForm">
                            <div class="channel-type-selector">
                                <div class="channel-type-btn active" data-type="text">
                                    üí¨ Texto
                                </div>
                                <div class="channel-type-btn" data-type="voice">
                                    üîä Voz
                                </div>
                            </div>
                            
                            <div class="channel-creation">
                                <div class="form-group">
                                    <label for="channelName">Nome do Canal:</label>
                                    <input type="text" id="channelName" placeholder="nome-do-canal" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="categorySelect">Categoria:</label>
                                    <select id="categorySelect">
                                        <option value="">Sem categoria</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="channelTopic">T√≥pico/Descri√ß√£o:</label>
                                <input type="text" id="channelTopic" placeholder="Descri√ß√£o do canal (opcional)" maxlength="1024">
                            </div>
                            
                            <button type="submit" class="btn btn-success" id="createChannelBtn">
                                ‚ûï Criar Canal
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Templates Salvos -->
            <div class="templates-section">
                <h2>üìö Templates Salvos</h2>
                <div class="filter-bar">
                    <input type="text" id="templateSearch" placeholder="üîç Buscar templates...">
                    <select id="categoryFilter">
                        <option value="">Todas as categorias</option>
                        <option value="Geral">Geral</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Avisos">Avisos</option>
                        <option value="Torneios">Torneios</option>
                        <option value="Atualiza√ß√µes">Atualiza√ß√µes</option>
                    </select>
                </div>
                <div id="templatesList"></div>
            </div>

            <!-- Canais Criados -->
            <div class="channels-section">
                <h2>üì∫ Canais Gerenciados</h2>
                <div class="filter-bar">
                    <input type="text" id="channelSearch" placeholder="üîç Buscar canais...">
                    <button class="btn btn-small btn-secondary" onclick="loadChannelTemplates()">
                        üîÑ Atualizar
                    </button>
                </div>
                <div id="channelsList"></div>
            </div>

            <!-- Hist√≥rico -->
            <div class="history-section">
                <h2>üìã Hist√≥rico de Atividades</h2>
                <div class="filter-bar">
                    <input type="text" id="historySearch" placeholder="üîç Buscar no hist√≥rico...">
                    <select id="historyChannelFilter">
                        <option value="">Todos os canais</option>
                    </select>
                </div>
                <div id="announcementHistory"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = window.location.hostname === 'localhost' ? 
            'http://localhost:3001/api' : 
            'https://discord-anuncios.onrender.com/api';

        let authToken = localStorage.getItem('authToken');
        let selectedRoles = [];
        let selectedAnnouncementType = 'anuncio';
        let selectedChannelType = 'text';
        let allTemplates = [];
        let allChannels = [];
        let allRoles = [];

        // Verificar autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                verifyToken();
            } else {
                showLogin();
            }
            
            setupEventListeners();
        });

        function setupEventListeners() {
            // Seletores de tipo de an√∫ncio
            document.querySelectorAll('.announcement-type').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.announcement-type').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedAnnouncementType = this.dataset.type;
                });
            });

            // Seletores de tipo de canal
            document.querySelectorAll('.channel-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.channel-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedChannelType = this.dataset.type;
                });
            });

            // Emojis
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const emoji = this.dataset.emoji;
                    const textarea = document.getElementById('announcementText');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    textarea.value = text.substring(0, start) + emoji + text.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                    textarea.focus();
                    updateCharCounter();
                });
            });

            // Contadores de caracteres
            document.getElementById('announcementText').addEventListener('input', updateCharCounter);
            document.getElementById('templateContent').addEventListener('input', updateTemplateCharCounter);
            
            // Templates
            document.getElementById('templateSelect').addEventListener('change', function() {
                if (this.value) {
                    useTemplate(parseInt(this.value));
                }
            });

            // Filtros
            document.getElementById('templateSearch').addEventListener('input', renderTemplatesList);
            document.getElementById('categoryFilter').addEventListener('change', renderTemplatesList);
            document.getElementById('channelSearch').addEventListener('input', renderChannelsList);
        }

        // Verificar token
        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showMainInterface();
                    loadAllData();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Erro ao verificar token:', error);
                showLogin();
            }
        }

        // Mostrar interfaces
        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainInterface').style.display = 'none';
            localStorage.removeItem('authToken');
            authToken = null;
        }

        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading-spinner"></div>Entrando...';
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    showMessage('loginMessage', result.message, 'success');
                    
                    setTimeout(() => {
                        showMainInterface();
                        loadAllData();
                    }, 1000);
                } else {
                    showMessage('loginMessage', result.error, 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Erro de conex√£o com o servidor.', 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Entrar';
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            showLogin();
        }

        // Carregar todos os dados
        async function loadAllData() {
            await Promise.all([
                loadStats(),
                loadChannels(),
                loadRoles(),
                loadTemplates(),
                loadCategories(),
                loadHistory()
            ]);
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const stats = await response.json();
                
                document.getElementById('statsAnnouncements').textContent = stats.totalAnnouncements || 0;
                document.getElementById('statsChannels').textContent = stats.channels || 0;
                document.getElementById('statsRoles').textContent = stats.roles || 0;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Carregar canais
        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/channels`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                allChannels = data.channels || [];
                
                const channelSelect = document.getElementById('channelSelect');
                const historyChannelFilter = document.getElementById('historyChannelFilter');
                
                channelSelect.innerHTML = '<option value="">Selecione um canal</option>';
                historyChannelFilter.innerHTML = '<option value="">Todos os canais</option>';
                
                // Agrupar por servidor
                Object.keys(data.channelsGrouped || {}).forEach(guildName => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = guildName;
                    
                    data.channelsGrouped[guildName].forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.id;
                        option.textContent = `#${channel.name} ${channel.category ? `(${channel.category})` : ''}`;
                        optgroup.appendChild(option);
                        
                        const historyOption = option.cloneNode(true);
                        historyChannelFilter.appendChild(historyOption);
                    });
                    
                    channelSelect.appendChild(optgroup);
                });
                
                renderChannelsList();
                
            } catch (error) {
                console.error('Erro ao carregar canais:', error);
                document.getElementById('channelSelect').innerHTML = '<option value="">Erro ao carregar canais</option>';
            }
        }

      // Carregar cargos
async function loadRoles() {
    try {
        // Obtenha o token de autentica√ß√£o salvo no navegador
        const authToken = localStorage.getItem('token');
        
        // Se n√£o houver token, pare a execu√ß√£o e trate o erro
        if (!authToken) {
            console.error('Token de autentica√ß√£o n√£o encontrado.');
            renderRoles([]); // Renderiza o estado vazio ou um erro
            return;
        }

        const response = await fetch(`${API_BASE}/roles`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        // Trate a resposta, inclusive se houver erro
        if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
        }

        const roles = await response.json();
        
        allRoles = roles;
        renderRoles();
        
    } catch (error) {
        console.error('Erro ao carregar cargos:', error);
        renderRoles([]); // Renderiza o estado vazio
    }
}

        // Renderizar cargos
        function renderRoles(roles = allRoles) {
            const rolesGrid = document.getElementById('rolesGrid');
            
            if (!roles || roles.length === 0) {
                rolesGrid.innerHTML = `
                    <div class="role-item" style="grid-column: 1/-1; text-align: center; color: #666;">
                        <div style="margin-right: 8px;">‚ö†Ô∏è</div>
                        Nenhum cargo encontrado ou bot sem permiss√µes
                    </div>
                `;
                return;
            }
            
            rolesGrid.innerHTML = roles.map(role => `
                <div class="role-item" data-role-id="${role.id}" onclick="toggleRole('${role.id}')">
                    <div class="role-color" style="background-color: ${role.color || '#99aab5'};"></div>
                    <div class="role-name">${escapeHtml(role.name)}</div>
                </div>
            `).join('');
            
            updateMentionsPreview();
        }

        // Toggle sele√ß√£o de cargo
        function toggleRole(roleId) {
            const roleElement = document.querySelector(`[data-role-id="${roleId}"]`);
            const index = selectedRoles.indexOf(roleId);
            
            if (index > -1) {
                selectedRoles.splice(index, 1);
                roleElement.classList.remove('selected');
            } else {
                selectedRoles.push(roleId);
                roleElement.classList.add('selected');
            }
            
            updateMentionsPreview();
        }

        // Atualizar preview das men√ß√µes
        function updateMentionsPreview() {
            const mentionsPreview = document.getElementById('mentionsPreview');
            const mentionTags = document.getElementById('mentionTags');
            
            if (selectedRoles.length === 0) {
                mentionsPreview.classList.remove('show');
                return;
            }
            
            mentionsPreview.classList.add('show');
            
            const selectedRoleNames = selectedRoles.map(roleId => {
                const role = allRoles.find(r => r.id === roleId);
                return role ? role.name : 'Cargo n√£o encontrado';
            });
            
            mentionTags.innerHTML = selectedRoleNames.map(name => 
                `<span class="mention-tag">@${escapeHtml(name)}</span>`
            ).join('');
        }

        // Carregar categorias
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const categories = await response.json();
                
                const categorySelect = document.getElementById('categorySelect');
                categorySelect.innerHTML = '<option value="">Sem categoria</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                allTemplates = await response.json();
                
                updateTemplateSelect();
                renderTemplatesList();
            } catch (error) {
                console.error('Erro ao carregar templates:', error);
                allTemplates = [];
                renderTemplatesList();
            }
        }

        // Carregar hist√≥rico
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const history = await response.json();
                
                renderHistory(history);
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                renderHistory([]);
            }
        }

        // Renderizar hist√≥rico
        function renderHistory(history) {
            const historyContainer = document.getElementById('announcementHistory');
            
            if (!history || history.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">üìã</div>
                        <p>Nenhuma atividade registrada.</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = history.map(item => {
                const typeIcons = {
                    'anuncio': 'üì¢',
                    'novidade': '‚ú®',
                    'atualizacao': 'üîÑ',
                    'torneio': 'üèÜ',
                    'evento': 'üéâ',
                    'aviso': '‚ö†Ô∏è'
                };
                
                return `
                    <div class="template-item fade-in">
                        <div class="template-header">
                            <div class="template-info">
                                <div class="template-name">
                                    ${typeIcons[item.type] || 'üì¢'} ${escapeHtml(item.type || 'An√∫ncio')}
                                </div>
                                <div class="template-category">${escapeHtml(item.channelName || 'Canal desconhecido')}</div>
                                <div class="template-preview">${escapeHtml(item.content || 'Sem conte√∫do')}</div>
                                <div style="font-size: 0.8rem; color: #999; margin-top: 10px;">
                                    Enviado em ${new Date(item.createdAt || Date.now()).toLocaleString('pt-BR')}
                                    ${item.mentions ? ` ‚Ä¢ ${item.mentions} men√ß√µes` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualizar select de templates
        function updateTemplateSelect() {
            const templateSelect = document.getElementById('templateSelect');
            templateSelect.innerHTML = '<option value="">Selecione um template</option>';
            
            allTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} (${template.category})`;
                templateSelect.appendChild(option);
            });
        }

        // Renderizar lista de templates
        function renderTemplatesList() {
            const templatesList = document.getElementById('templatesList');
            const searchTerm = document.getElementById('templateSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filteredTemplates = allTemplates.filter(template => {
                const matchesSearch = template.name.toLowerCase().includes(searchTerm) || 
                                    template.content.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || template.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            
            if (filteredTemplates.length === 0) {
                templatesList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">üìù</div>
                        <p>Nenhum template encontrado.</p>
                    </div>
                `;
                return;
            }
            
            templatesList.innerHTML = filteredTemplates.map(template => `
                <div class="template-item fade-in">
                    <div class="template-header">
                        <div class="template-info">
                            <div class="template-name">${escapeHtml(template.name)}</div>
                            <div class="template-category">${template.category}</div>
                            <div class="template-preview">${escapeHtml(template.content)}</div>
                            <div style="font-size: 0.8rem; color: #999; margin-top: 10px;">
                                Criado em ${new Date(template.createdAt).toLocaleDateString('pt-BR')}
                                ${template.usageCount ? ` ‚Ä¢ Usado ${template.usageCount} vezes` : ''}
                            </div>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-secondary btn-small" onclick="useTemplate(${template.id})">
                                ‚úèÔ∏è Usar
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="editTemplate(${template.id})">
                                üìù Editar
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteTemplate(${template.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Renderizar lista de canais
        function renderChannelsList() {
            const channelsList = document.getElementById('channelsList');
            const searchTerm = document.getElementById('channelSearch').value.toLowerCase();
            
            let filteredChannels = allChannels.filter(channel => 
                channel.name.toLowerCase().includes(searchTerm) || 
                (channel.guild && channel.guild.toLowerCase().includes(searchTerm))
            );
            
            if (filteredChannels.length === 0) {
                channelsList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;">üì∫</div>
                        <p>Nenhum canal encontrado.</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar por servidor
            const channelsByGuild = filteredChannels.reduce((groups, channel) => {
                const guildName = channel.guild || 'Servidor desconhecido';
                if (!groups[guildName]) {
                    groups[guildName] = [];
                }
                groups[guildName].push(channel);
                return groups;
            }, {});
            
            channelsList.innerHTML = Object.keys(channelsByGuild).map(guildName => `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #5865f2; margin-bottom: 10px; font-size: 1.1rem;">üõ°Ô∏è ${escapeHtml(guildName)}</h3>
                    ${channelsByGuild[guildName].map(channel => `
                        <div class="channel-item">
                            <div class="channel-name">#${escapeHtml(channel.name)}</div>
                            <div class="channel-type">${channel.category || 'Sem categoria'}</div>
                            <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                                ID: ${channel.id} ‚Ä¢ Tipo: ${channel.type || 'texto'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Usar template
        function useTemplate(templateId) {
            const template = allTemplates.find(t => t.id === templateId);
            if (template) {
                document.getElementById('announcementText').value = template.content;
                document.getElementById('templateSelect').value = templateId;
                updateCharCounter();
                showMessage('message', `Template "${template.name}" carregado!`, 'info');
                
                document.getElementById('announcementForm').scrollIntoView({ behavior: 'smooth' });
                
                // Incrementar contador de uso (opcional)
                incrementTemplateUsage(templateId);
            }
        }

        // Incrementar uso do template
        async function incrementTemplateUsage(templateId) {
            try {
                await fetch(`${API_BASE}/template/${templateId}/use`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
            } catch (error) {
                console.error('Erro ao incrementar uso do template:', error);
            }
        }

        // Editar template
        function editTemplate(templateId) {
            const template = allTemplates.find(t => t.id === templateId);
            if (template) {
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateCategory').value = template.category;
                document.getElementById('templateContent').value = template.content;
                
                const saveBtn = document.getElementById('saveTemplateBtn');
                saveBtn.textContent = '‚úèÔ∏è Atualizar';
                saveBtn.dataset.editId = templateId;
                
                updateTemplateCharCounter();
                document.getElementById('templateForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Excluir template
        async function deleteTemplate(templateId) {
            const template = allTemplates.find(t => t.id === templateId);
            if (!confirm(`Tem certeza que deseja excluir o template "${template.name}"?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/template/${templateId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showMessage('message', 'Template exclu√≠do com sucesso!', 'success');
                    loadTemplates();
                    loadStats();
                } else {
                    showMessage('message', 'Erro ao excluir template.', 'error');
                }
            } catch (error) {
                showMessage('message', 'Erro de conex√£o.', 'error');
            }
        }

        // Contadores de caracteres
        function updateCharCounter() {
            const text = document.getElementById('announcementText').value;
            const counter = document.getElementById('charCounter');
            const length = text.length;
            
            counter.textContent = `${length}/2000 caracteres`;
            
            if (length > 1800) {
                counter.className = 'char-counter danger';
            } else if (length > 1500) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
        }

        function updateTemplateCharCounter() {
            const text = document.getElementById('templateContent').value;
            const counter = document.getElementById('templateCharCounter');
            const length = text.length;
            
            counter.textContent = `${length}/2000 caracteres`;
            
            if (length > 1800) {
                counter.className = 'char-counter danger';
            } else if (length > 1500) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
        }

        // Atualizar dados
        async function refreshChannels() {
            showMessage('message', 'Atualizando dados...', 'info');
            await Promise.all([loadChannels(), loadRoles(), loadCategories()]);
            showMessage('message', 'Dados atualizados com sucesso!', 'success');
        }

        // Carregar templates de canais
        async function loadChannelTemplates() {
            showMessage('message', 'Atualizando lista de canais...', 'info');
            await loadChannels();
            showMessage('message', 'Lista de canais atualizada!', 'success');
        }

        // Limpar formul√°rio
        function clearForm() {
            document.getElementById('announcementText').value = '';
            document.getElementById('templateSelect').value = '';
            document.getElementById('channelSelect').value = '';
            selectedRoles = [];
            document.querySelectorAll('.role-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.announcement-type').forEach(item => item.classList.remove('selected'));
            document.querySelector('.announcement-type[data-type="anuncio"]').classList.add('selected');
            selectedAnnouncementType = 'anuncio';
            updateCharCounter();
            updateMentionsPreview();
            showMessage('message', 'Formul√°rio limpo!', 'info');
        }

        // Visualizar an√∫ncio
        function previewAnnouncement() {
            const content = document.getElementById('announcementText').value;
            const channelSelect = document.getElementById('channelSelect');
            const channelName = channelSelect.options[channelSelect.selectedIndex]?.text || 'Canal n√£o selecionado';
            
            if (!content.trim()) {
                showMessage('message', 'Digite uma mensagem para visualizar.', 'error');
                return;
            }

            const typeIcons = {
                'anuncio': 'üì¢',
                'novidade': '‚ú®',
                'atualizacao': 'üîÑ',
                'torneio': 'üèÜ',
                'evento': 'üéâ',
                'aviso': '‚ö†Ô∏è'
            };

            const typeNames = {
                'anuncio': 'An√∫ncio',
                'novidade': 'Novidade',
                'atualizacao': 'Atualiza√ß√£o',
                'torneio': 'Inscri√ß√£o de Torneio',
                'evento': 'Evento',
                'aviso': 'Aviso'
            };
            
            const mentionsText = selectedRoles.length > 0 ? 
                `<div style="margin-bottom: 10px; color: #5865f2; font-weight: bold;">
                    Cargos mencionados: ${selectedRoles.map(roleId => {
                        const role = allRoles.find(r => r.id === roleId);
                        return `@${role ? role.name : 'Cargo desconhecido'}`;
                    }).join(', ')}
                </div>` : '';
            
            const previewWindow = window.open('', '_blank', 'width=700,height=500');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>JOJO AN√öNCIOS - Visualiza√ß√£o</title>
                    <style>
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            background: #36393f; 
                            color: #dcddde; 
                            padding: 20px; 
                            margin: 0;
                        }
                        .embed {
                            background: #2f3136;
                            border-left: 4px solid #5865f2;
                            border-radius: 8px;
                            padding: 20px;
                            max-width: 600px;
                        }
                        .embed-title { 
                            color: #fff; 
                            font-weight: bold; 
                            margin-bottom: 15px; 
                            font-size: 20px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .embed-description { 
                            line-height: 1.6; 
                            white-space: pre-wrap; 
                            font-size: 16px;
                        }
                        .embed-footer { 
                            margin-top: 15px; 
                            font-size: 12px; 
                            color: #72767d; 
                            border-top: 1px solid #40444b;
                            padding-top: 10px;
                        }
                        .channel-info {
                            background: #40444b;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            font-size: 14px;
                        }
                        .mentions-info {
                            background: rgba(88, 101, 242, 0.1);
                            border: 1px solid #5865f2;
                            padding: 10px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                        }
                    </style>
                </head>
                <body>
                    <div class="channel-info">
                        <strong>üéØ JOJO AN√öNCIOS - PREVIEW</strong><br>
                        <strong>Canal:</strong> ${channelName}<br>
                        <strong>Tipo:</strong> ${typeNames[selectedAnnouncementType]}
                    </div>
                    ${mentionsText ? `<div class="mentions-info">${mentionsText}</div>` : ''}
                    <div class="embed">
                        <div class="embed-title">
                            ${typeIcons[selectedAnnouncementType]} ${typeNames[selectedAnnouncementType]}
                        </div>
                        <div class="embed-description">${content.replace(/\n/g, '<br>')}</div>
                        <div class="embed-footer">
                            JOJO AN√öNCIOS POR PAINEL WEB ‚Ä¢ ${new Date().toLocaleString('pt-BR')}
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Enviar an√∫ncio
        document.getElementById('announcementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const channelId = document.getElementById('channelSelect').value;
            const content = document.getElementById('announcementText').value;
            const sendBtn = document.getElementById('sendBtn');
            
            if (!channelId || !content.trim()) {
                showMessage('message', 'Preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading-spinner"></div>Enviando...';
            
            try {
                const response = await fetch(`${API_BASE}/announcement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        channelId, 
                        content, 
                        roles: selectedRoles,
                        type: selectedAnnouncementType
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('message', 'An√∫ncio enviado com sucesso! üéâ', 'success');
                    clearForm();
                    loadStats();
                    loadHistory();
                } else {
                    showMessage('message', result.error || 'Erro ao enviar an√∫ncio.', 'error');
                }
            } catch (error) {
                showMessage('message', 'Erro de conex√£o com o servidor.', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üì§ Enviar An√∫ncio';
            }
        });

        // Salvar template
        document.getElementById('templateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('templateName').value.trim();
            const content = document.getElementById('templateContent').value.trim();
            const category = document.getElementById('templateCategory').value;
            const saveBtn = document.getElementById('saveTemplateBtn');
            const isEditing = saveBtn.dataset.editId;
            
            if (!name || !content) {
                showMessage('message', 'Nome e conte√∫do s√£o obrigat√≥rios.', 'error');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = isEditing ? 
                '<div class="loading-spinner"></div>Atualizando...' : 
                '<div class="loading-spinner"></div>Salvando...';
            
            try {
                const url = isEditing ? 
                    `${API_BASE}/template/${isEditing}` : 
                    `${API_BASE}/template`;
                
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name, content, category })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const successMessage = isEditing ? 
                        'Template atualizado com sucesso! ‚úèÔ∏è' : 
                        'Template salvo com sucesso! üíæ';
                    
                    showMessage('message', successMessage, 'success');
                    
                    // Limpar formul√°rio
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateContent').value = '';
                    document.getElementById('templateCategory').value = 'Geral';
                    updateTemplateCharCounter();
                    
                    // Resetar bot√£o
                    saveBtn.textContent = 'üíæ Salvar';
                    delete saveBtn.dataset.editId;
                    
                    loadTemplates();
                    loadStats();
                } else {
                    showMessage('message', result.error || 'Erro ao salvar template.', 'error');
                }
            } catch (error) {
                showMessage('message', 'Erro de conex√£o com o servidor.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = isEditing ? '‚úèÔ∏è Atualizar' : 'üíæ Salvar';
            }
        });

        // Criar canal
        document.getElementById('channelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('channelName').value.trim().toLowerCase().replace(/\s+/g, '-');
            const topic = document.getElementById('channelTopic').value.trim();
            const categoryId = document.getElementById('categorySelect').value;
            const createBtn = document.getElementById('createChannelBtn');
            
            if (!name) {
                showMessage('message', 'Nome do canal √© obrigat√≥rio.', 'error');
                return;
            }
            
            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="loading-spinner"></div>Criando...';
            
            try {
                const response = await fetch(`${API_BASE}/channel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        name, 
                        topic, 
                        type: selectedChannelType,
                        categoryId: categoryId || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('message', 'Canal criado com sucesso! üì∫', 'success');
                    
                    // Limpar formul√°rio
                    document.getElementById('channelName').value = '';
                    document.getElementById('channelTopic').value = '';
                    document.getElementById('categorySelect').value = '';
                    
                    loadChannels();
                    loadStats();
                } else {
                    showMessage('message', result.error || 'Erro ao criar canal.', 'error');
                }
            } catch (error) {
                showMessage('message', 'Erro de conex√£o com o servidor.', 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '‚ûï Criar Canal';
            }
        });

        // Fun√ß√£o para mostrar mensagens
        function showMessage(containerId, message, type) {
            const messageDiv = document.getElementById(containerId);
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };
            
            messageDiv.innerHTML = `
                <div class="${type}">
                    ${icons[type] || ''} ${message}
                </div>
            `;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Fun√ß√£o para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter para enviar an√∫ncio
            if (e.ctrlKey && e.key === 'Enter') {
                const announcementText = document.getElementById('announcementText');
                if (document.activeElement === announcementText) {
                    document.getElementById('sendBtn').click();
                }
            }
            
            // Ctrl+L para limpar formul√°rio
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearForm();
            }
            
            // Ctrl+P para preview
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                previewAnnouncement();
            }
        });

        // Adicionar tooltips informativos
        function addTooltips() {
            const tooltipElements = [
                { id: 'channelSelect', text: 'Selecione o canal onde o an√∫ncio ser√° enviado' },
                { id: 'templateSelect', text: 'Escolha um template salvo para preencher automaticamente' },
                { id: 'announcementText', text: 'Digite sua mensagem. Use Ctrl+Enter para enviar rapidamente' }
            ];
            
            tooltipElements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                }
            });
        }

        // Auto-save do conte√∫do do formul√°rio
        function enableAutoSave() {
            const textArea = document.getElementById('announcementText');
            const AUTOSAVE_KEY = 'jojo_anuncios_draft';
            
            // Carregar draft ao iniciar
            const savedDraft = localStorage.getItem(AUTOSAVE_KEY);
            if (savedDraft && !textArea.value) {
                textArea.value = savedDraft;
                updateCharCounter();
                showMessage('message', 'Rascunho recuperado automaticamente.', 'info');
            }
            
            // Salvar automaticamente enquanto digita
            let saveTimer;
            textArea.addEventListener('input', function() {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    if (this.value.trim()) {
                        localStorage.setItem(AUTOSAVE_KEY, this.value);
                    } else {
                        localStorage.removeItem(AUTOSAVE_KEY);
                    }
                }, 1000);
            });
            
            // Limpar draft ao enviar
            document.getElementById('announcementForm').addEventListener('submit', function() {
                localStorage.removeItem(AUTOSAVE_KEY);
            });
        }

        // Valida√ß√£o em tempo real
        function setupFormValidation() {
            const channelSelect = document.getElementById('channelSelect');
            const announcementText = document.getElementById('announcementText');
            const sendBtn = document.getElementById('sendBtn');
            
            function validateForm() {
                const isValid = channelSelect.value && announcementText.value.trim();
                sendBtn.disabled = !isValid;
                
                if (!isValid) {
                    sendBtn.style.opacity = '0.5';
                } else {
                    sendBtn.style.opacity = '1';
                }
            }
            
            channelSelect.addEventListener('change', validateForm);
            announcementText.addEventListener('input', validateForm);
            
            // Valida√ß√£o inicial
            validateForm();
        }

        // Melhorar experi√™ncia de busca
        function enhanceSearch() {
            // Debounce para os filtros de busca
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Aplicar debounce aos campos de busca
            const searches = [
                { id: 'templateSearch', callback: renderTemplatesList },
                { id: 'channelSearch', callback: renderChannelsList },
                { id: 'historySearch', callback: () => loadHistory() }
            ];
            
            searches.forEach(({ id, callback }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounce(callback, 300));
                }
            });
        }

        // Contador de caracteres em tempo real melhorado
        function enhanceCharCounters() {
            const counters = [
                { textId: 'announcementText', counterId: 'charCounter', max: 2000 },
                { textId: 'templateContent', counterId: 'templateCharCounter', max: 2000 }
            ];
            
            counters.forEach(({ textId, counterId, max }) => {
                const textElement = document.getElementById(textId);
                const counterElement = document.getElementById(counterId);
                
                if (textElement && counterElement) {
                    textElement.addEventListener('input', function() {
                        const length = this.value.length;
                        const remaining = max - length;
                        
                        let text = `${length}/${max} caracteres`;
                        if (remaining < 200) {
                            text += ` (${remaining} restantes)`;
                        }
                        
                        counterElement.textContent = text;
                        
                        // Atualizar classes
                        counterElement.className = 'char-counter';
                        if (length > max * 0.9) {
                            counterElement.className += ' danger';
                        } else if (length > max * 0.75) {
                            counterElement.className += ' warning';
                        }
                    });
                }
            });
        }

        // Inicializar funcionalidades extras
        function initializeExtraFeatures() {
            addTooltips();
            enableAutoSave();
            setupFormValidation();
            enhanceSearch();
            enhanceCharCounters();
        }

        // Chamar inicializa√ß√£o extra ap√≥s carregar a interface
        const originalShowMainInterface = showMainInterface;
        showMainInterface = function() {
            originalShowMainInterface();
            setTimeout(initializeExtraFeatures, 100);
        };

        // Easter egg - Konami Code
        let konamiCode = [];
        const konami = [38,38,40,40,37,39,37,39,66,65];
        
        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.keyCode);
            if (konamiCode.length > konami.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.join(',') === konami.join(',')) {
                showMessage('message', 'üéâ JOJO MODE ATIVADO! Voc√™ descobriu o c√≥digo secreto!', 'success');
                document.body.style.animation = 'rainbow 2s linear infinite';
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes rainbow {
                        0% { filter: hue-rotate(0deg); }
                        100% { filter: hue-rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    document.body.style.animation = '';
                    style.remove();
                }, 10000);
                
                konamiCode = [];
            }
        });

        // Anima√ß√µes de entrada
        function animateElements() {
            const elements = document.querySelectorAll('.panel-section, .template-item, .channel-item');
            elements.forEach((el, index) => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    el.style.transition = 'all 0.5s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // Chamar anima√ß√µes quando carregar dados
        const originalLoadAllData = loadAllData;
        loadAllData = async function() {
            await originalLoadAllData();
            setTimeout(animateElements, 200);
        };

    </script>
</body>
</html>
